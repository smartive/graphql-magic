"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[188],{9701:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"migration-guides","title":"Migration Guides","description":"Upgrading to v19.0.0","source":"@site/docs/11-migration-guides.md","sourceDirName":".","slug":"/migration-guides","permalink":"/graphql-magic/docs/migration-guides","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":11,"frontMatter":{},"sidebar":"sidebar","previous":{"title":"Admin UI (TODO)","permalink":"/graphql-magic/docs/admin-ui"}}');var o=i(4848),s=i(8453);const r={},d="Migration Guides",a={},l=[{value:"Upgrading to v19.0.0",id:"upgrading-to-v1900",level:2},{value:"Configuration changes",id:"configuration-changes",level:3},{value:"Enhanced delete functionality",id:"enhanced-delete-functionality",level:3},{value:"New <code>onDelete</code> option: <code>restrict</code>",id:"new-ondelete-option-restrict",level:4},{value:"Database schema changes",id:"database-schema-changes",level:4},{value:"Mutation hook signature changes",id:"mutation-hook-signature-changes",level:3},{value:"Upgrading to v18.0.0",id:"upgrading-to-v1800",level:2},{value:"Upgrading to v17.2.0",id:"upgrading-to-v1720",level:2}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"migration-guides",children:"Migration Guides"})}),"\n",(0,o.jsx)(n.h2,{id:"upgrading-to-v1900",children:"Upgrading to v19.0.0"}),"\n",(0,o.jsx)(n.h3,{id:"configuration-changes",children:"Configuration changes"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["The ",(0,o.jsx)(n.code,{children:"gqlModule"})," configuration property has been renamed to ",(0,o.jsx)(n.code,{children:"gqmModule"})," to maintain consistency with the project naming. Please update your ",(0,o.jsx)(n.code,{children:".gqmrc.json"})," file accordingly:"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-diff",children:'{\n  "modelsPath": "path/to/models.ts",\n  "generatedFolderPath": "path/to/generated",\n  "graphqlQueriesPath": "path/to/queries",\n- "gqlModule": "../path/to/module",\n+ "gqmModule": "../path/to/module",\n  "knexfilePath": "knexfile.ts",\n  "dateLibrary": "luxon"\n}\n'})}),"\n",(0,o.jsx)(n.h3,{id:"enhanced-delete-functionality",children:"Enhanced delete functionality"}),"\n",(0,o.jsxs)(n.h4,{id:"new-ondelete-option-restrict",children:["New ",(0,o.jsx)(n.code,{children:"onDelete"})," option: ",(0,o.jsx)(n.code,{children:"restrict"})]}),"\n",(0,o.jsxs)(n.p,{children:["You can now use ",(0,o.jsx)(n.code,{children:"restrict"})," as an ",(0,o.jsx)(n.code,{children:"onDelete"})," option for relations, in addition to the existing ",(0,o.jsx)(n.code,{children:"cascade"})," and ",(0,o.jsx)(n.code,{children:"set-null"})," options:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:"{\n  name: 'author',\n  type: 'User',\n  kind: 'relation',\n  onDelete: 'restrict', // New option\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["When using ",(0,o.jsx)(n.code,{children:"restrict"}),", deletion of a parent entity will be prevented if it has related child entities, ensuring referential integrity."]}),"\n",(0,o.jsx)(n.h4,{id:"database-schema-changes",children:"Database schema changes"}),"\n",(0,o.jsx)(n.p,{children:"New fields have been added to deletable entities to track deletion context:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"deleteRootType"}),": Stores the type of the root entity that initiated the deletion"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"deleteRootId"}),": Stores the ID of the root entity that initiated the deletion"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Generate a migration to add these fields:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"npx gqm generate-migration\n"})}),"\n",(0,o.jsx)(n.h3,{id:"mutation-hook-signature-changes",children:"Mutation hook signature changes"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"MutationHook"})," function signature has been updated to use object destructuring for better maintainability and extensibility. Update your mutation hook implementations:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-diff",children:"- export const mutationHook: MutationHook = (model, action, when, data, ctx) => {\n+ export const mutationHook: MutationHook = ({ model, action, trigger, when, data, ctx }) => {\n    // Your implementation\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["The new signature includes a ",(0,o.jsx)(n.code,{children:"trigger"})," parameter that indicates how the mutation was initiated:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"'mutation'"}),": Direct GraphQL mutation"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"'cascade'"}),": Triggered by cascading delete"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"'set-null'"}),": Triggered by setting foreign key to null"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"upgrading-to-v1800",children:"Upgrading to v18.0.0"}),"\n",(0,o.jsx)(n.p,{children:"This was a dummy release, nothing to do here."}),"\n",(0,o.jsx)(n.h2,{id:"upgrading-to-v1720",children:"Upgrading to v17.2.0"}),"\n",(0,o.jsx)(n.p,{children:"From now on, foreign keys will be indexed by default. For existing projects, you'll need to add indices manually to your existing foreign keys."}),"\n",(0,o.jsx)(n.p,{children:"Here's a sample script to generate the migration:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:"import { execSync } from 'child_process';\nimport { writeFileSync } from 'fs';\nimport { models } from '../../../src/config/models';\n\nconst start = async () => {\n  const instructions: string[] = [];\n\n  instructions.push(`import { Knex } from 'knex';\n\nexport const up = async (knex: Knex) => {`);\n\n  for (const model of models.entities) {\n    if (model.fields.some((field) => field.kind === 'relation')) {\n      instructions.push(`await knex.schema.alterTable('${model.name}', (table) => {`);\n      for (const field of model.fields) {\n        if (field.kind === 'relation') {\n          instructions.push(`table.index('${field.foreignKey || field.name + 'Id'}');`);\n        }\n      }\n      instructions.push(`});`);\n    }\n  }\n\n  instructions.push(`};`);\n\n  instructions.push(`export const down = async (knex: Knex) => {`);\n\n  for (const model of models.entities) {\n    if (model.fields.some((field) => field.kind === 'relation')) {\n      instructions.push(`await knex.schema.alterTable('${model.name}', (table) => {`);\n      for (const field of model.fields) {\n        if (field.kind === 'relation') {\n          instructions.push(`table.dropIndex('${field.foreignKey || field.name + 'Id'}');`);\n        }\n      }\n      instructions.push(`});`);\n    }\n  }\n\n  instructions.push(`};`);\n\n  writeFileSync('migrations/20250305130109_create-foreign-key-indices.ts', instructions.join('\\n'));\n  execSync('npx eslint --fix migrations/20250305130109_create-foreign-key-indices.ts');\n};\n\nvoid start();\n"})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>d});var t=i(6540);const o={},s=t.createContext(o);function r(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);