"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[986],{2385:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var a=t(4848),s=t(8453);const r={},i="Tutorial",o={id:"tutorial",title:"Tutorial",description:"Let's create a blog with graphql-magic!",source:"@site/docs/1-tutorial.md",sourceDirName:".",slug:"/tutorial",permalink:"/graphql-magic/docs/tutorial",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{},sidebar:"sidebar",next:{title:"Models",permalink:"/graphql-magic/docs/models"}},l={},c=[{value:"Setup",id:"setup",level:2},{value:"Code base",id:"code-base",level:3},{value:"Install graphql-magic",id:"install-graphql-magic",level:3},{value:"Database setup",id:"database-setup",level:3},{value:"Auth setup",id:"auth-setup",level:3},{value:"Account setup",id:"account-setup",level:3},{value:"Content!",id:"content",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"tutorial",children:"Tutorial"}),"\n",(0,a.jsxs)(n.p,{children:["Let's create a blog with ",(0,a.jsx)(n.code,{children:"graphql-magic"}),"!"]}),"\n",(0,a.jsx)(n.h2,{id:"setup",children:"Setup"}),"\n",(0,a.jsx)(n.h3,{id:"code-base",children:"Code base"}),"\n",(0,a.jsxs)(n.p,{children:["First create a ",(0,a.jsx)(n.code,{children:"next.js"})," website:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"npx create-next-app@latest magic-blog --ts --app --tailwind --eslint --src-dir\ncd magic-blog\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Replace ",(0,a.jsx)(n.code,{children:"src/app/globals.css"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-css",children:"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\nmain {\n    @apply w-96 mx-auto\n}\n\nnav {\n    @apply flex items-center\n}\n\nh1, h2, h3, h4 {\n    @apply font-bold\n}\n\nh1 {\n    @apply text-4xl mb-4 flex-grow\n}\n\nh2 {\n    @apply text-3xl mb-3\n}\n\nh3 {\n    @apply text-2xl mb-2\n}\n\nh4 {\n    @apply text-xl mb-1\n}\n\na {\n    @apply text-blue-500\n}\n\narticle, form {\n    @apply mb-4 p-3 rounded-lg shadow-md border border-gray-100\n}\n\ninput, textarea {\n    @apply border border-gray-300 w-full rounded-md p-1\n}\n\nlabel span {\n    @apply font-bold\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Replace ",(0,a.jsx)(n.code,{children:"src/app/page.tsx"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-tsx",children:"export default async function Home() {\n    return <main>\n      <nav>\n        <h1>Magic Blog</h1>\n      </nav>\n    </main>\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Start the website:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npm run dev\n"})}),"\n",(0,a.jsx)(n.h3,{id:"install-graphql-magic",children:"Install graphql-magic"}),"\n",(0,a.jsxs)(n.p,{children:["Add this setting to ",(0,a.jsx)(n.code,{children:"next.config.mjs"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"const nextConfig = {\n    experimental: {\n        serverComponentsExternalPackages: ['knex'],\n    }\n};\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Install ",(0,a.jsx)(n.code,{children:"@smartive/graphql-magic"})," and needed dependencies:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npm install @smartive/graphql-magic @graphql-codegen/typescript-compatibility\n"})}),"\n",(0,a.jsx)(n.p,{children:"Run the gqm cli:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npx gqm generate\n"})}),"\n",(0,a.jsx)(n.h3,{id:"database-setup",children:"Database setup"}),"\n",(0,a.jsxs)(n.p,{children:["Let's boot a local database instance.\nCreate the following ",(0,a.jsx)(n.code,{children:"docker-compose.yml"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yml",children:"version: '3.4'\nservices:\n  postgres:\n    image: postgres:13-alpine\n    shm_size: 1gb\n    environment:\n      POSTGRES_DB: postgres\n      POSTGRES_USER: postgres\n      POSTGRES_PASSWORD: password\n      POSTGRES_HOST_AUTH_METHOD: trust\n    ports:\n      - '5432:5432'\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Then start it with ",(0,a.jsx)(n.code,{children:"docker-compose up"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"Generate the first migration:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npx gqm generate-migration\n"})}),"\n",(0,a.jsx)(n.p,{children:'Enter a migration name, e.g. "setup".'}),"\n",(0,a.jsx)(n.p,{children:"Run the migration"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npx env-cmd knex migrate:latest\n"})}),"\n",(0,a.jsx)(n.h3,{id:"auth-setup",children:"Auth setup"}),"\n",(0,a.jsxs)(n.p,{children:["Set up a way for users to authenticate with your app.\nFor example, follow ",(0,a.jsx)(n.a,{href:"https://auth0.com/docs/quickstart/webapp/nextjs/01-login",children:"this tutorial"})," to set up auth0."]}),"\n",(0,a.jsxs)(n.p,{children:["Assuming you used auth0, here's a bare-bones version of what ",(0,a.jsx)(n.code,{children:"src/app/page.tsx"})," could look like:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-tsx",children:'import { getSession } from \'@auth0/nextjs-auth0\';\n\nexport default async function Page() {\n  const session = await getSession();\n\n  return <main>\n    <nav>\n      <h1>Welcome to my Blog</h1>\n      {session ? <a href="/api/auth/logout">Logout</a> : <a href="/api/auth/login">Login</a>}\n    </nav>\n  </main>\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"It should now be possible for you to log in and out again."}),"\n",(0,a.jsx)(n.h3,{id:"account-setup",children:"Account setup"}),"\n",(0,a.jsx)(n.p,{children:"Now, we need to ensure that the user is stored in the database."}),"\n",(0,a.jsxs)(n.p,{children:["First extend the user model in ",(0,a.jsx)(n.code,{children:"src/config/models.ts"})," with the following fields:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-tsx",children:"    fields: [\n      {\n        name: 'authId',\n        type: 'String',\n        nonNull: true,\n      },\n      {\n        name: 'username',\n        type: 'String',\n        nonNull: true\n      }\n    ]\n"})}),"\n",(0,a.jsx)(n.p,{children:"The models have changed, generate the new types:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npx gqm generate\n"})}),"\n",(0,a.jsx)(n.p,{children:"Generate the new migration:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npx gqm generate-migration\n"})}),"\n",(0,a.jsx)(n.p,{children:"Edit the generated migration, then run it"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npx env-cmd knex migrate:latest\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Now let's implement the ",(0,a.jsx)(n.code,{children:"// TODO: get user"})," part in the ",(0,a.jsx)(n.code,{children:"src/graphql/execute.ts"})," file"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"  const session = await getSession();\n  if (session) {\n    let dbUser = await db('User').where({ authId: session.user.sub }).first();\n    if (!user) {\n      await db('User').insert({\n        id: randomUUID(),\n        authId: session.user.sub,\n        username: session.user.nickname\n      })\n      dbUser = await db('User').where({ authId: session.user.sub }).first();\n    }\n    user = {\n      ...dbUser!,\n      role: 'ADMIN'\n    }\n  }\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Extend ",(0,a.jsx)(n.code,{children:"src/graphql/client/queries/get-me.ts"})," to also fetch the user's username:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"import { gql } from '@smartive/graphql-magic';\n\nexport const GET_ME = gql`\n  query GetMe {\n    me {\n      id\n      username\n    }\n  }\n`;\n"})}),"\n",(0,a.jsx)(n.p,{children:"Generate the new types:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npx gqm generate\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Now, let's modify ",(0,a.jsx)(n.code,{children:"src/app/page.tsx"})," so that it fetches the user from the database:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-tsx",children:'import { GetMeQuery } from "@/generated/client";\nimport { GET_ME } from "@/graphql/client/queries/get-me";\nimport { executeGraphql } from "@/graphql/execute";\n\nexport default async function Home() {\n  const { data: { me } } = await executeGraphql<GetMeQuery>({ query: GET_ME });\n\n  return (\n    <main>\n      <nav>\n        <h1>Blog</h1>\n        {me ? <span>Hello, {me.username}! <a href="/api/auth/logout"> Logout</a></span> : <a href="/api/auth/login">Login</a>}\n      </nav>\n    </main>\n  );\n}\n'})}),"\n",(0,a.jsx)(n.h3,{id:"content",children:"Content!"}),"\n",(0,a.jsxs)(n.p,{children:["Let's make a blog out of this app by adding new models in ",(0,a.jsx)(n.code,{children:"src/config/models.ts"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"  {\n    kind: 'entity',\n    name: 'Post',\n    listQueriable: true,\n    creatable: true,\n    updatable: true,\n    deletable: true,\n    fields: [\n      {\n        name: 'title',\n        type: 'String',\n        nonNull: true,\n        creatable: true,\n        updatable: true,\n      },\n      {\n        name: 'content',\n        type: 'String',\n        nonNull: true,\n        creatable: true,\n        updatable: true,\n      }\n    ]\n  },\n  {\n    kind: 'entity',\n    name: 'Comment',\n    creatable: true,\n    updatable: true,\n    deletable: true,\n    fields: [\n      {\n        kind: 'relation',\n        name: 'post',\n        type: 'Post',\n        nonNull: true,\n        creatable: true,\n      },\n      {\n        name: 'content',\n        type: 'String',\n        nonNull: true,\n        creatable: true,\n        updatable: true,\n      }\n    ]\n  }\n"})}),"\n",(0,a.jsx)(n.p,{children:"Generate and run the new migrations and generate the new models:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npx gqm generate-migration\nnpx env-cmd knex migrate:latest\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Create a new query ",(0,a.jsx)(n.code,{children:"src/graphql/client/queries/get-posts.ts"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"import { gql } from '@smartive/graphql-magic';\n\nexport const GET_POSTS = gql`\n  query GetPosts {\n    posts {\n        id\n        title\n        content\n        createdBy {\n            username\n        }\n        comments {\n            id\n            createdBy {\n                username\n            }\n            content\n        }\n    }\n  }\n`;\n"})}),"\n",(0,a.jsx)(n.p,{children:"Generate the new types:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npx gqm generate\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Now add all the logic to create and display posts and comments to ",(0,a.jsx)(n.code,{children:"src/app/page.tsx"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-tsx",children:'import { CreateCommentMutationMutation, CreateCommentMutationMutationVariables, CreatePostMutationMutation, CreatePostMutationMutationVariables, GetMeQuery, GetPostsQuery } from "@/generated/client";\nimport { CREATE_COMMENT, CREATE_POST } from "@/generated/client/mutations";\nimport { GET_ME } from "@/graphql/client/queries/get-me";\nimport { GET_POSTS } from "@/graphql/client/queries/get-posts";\nimport { executeGraphql } from "@/graphql/execute";\nimport { revalidatePath } from "next/cache";\n\nexport default async function Home() {\n  const { data: { me } } = await executeGraphql<GetMeQuery>({ query: GET_ME });\n\n  return (\n    <main>\n      <nav>\n        <h1>Blog</h1>\n        {me ? <span>Hello, {me.username}! <a href="/api/auth/logout"> Logout</a></span> : <a href="/api/auth/login">Login</a>}\n      </nav>\n      {me && <CreatePost />}\n      <Posts me={me} />\n    </main>\n  );\n}\n\nasync function Posts({ me }: { me: GetMeQuery[\'me\'] }) {\n  const { data: { posts } } = await executeGraphql<GetPostsQuery>({ query: GET_POSTS })\n\n  return <div>\n    {posts.map(post => <div key={post.id}>\n      <article>\n        <h2>{post.title}</h2>\n        <div>by {post.createdBy.username}</div>\n        <p>{post.content}</p>\n        <h4>Comments</h4>\n        {post.comments.map(comment => (<div key={comment.id}>\n          <div>{comment.createdBy.username}</div>\n          <p>{comment.content}</p> by {comment.createdBy.username}\n        </div>)\n        )}\n        {me && <CreateComment postId={post.id} />}\n      </article>\n    </div>)}\n  </div>\n}\n\nasync function CreatePost() {\n  async function createPost(formData: FormData) {\n    \'use server\'\n    await executeGraphql<CreatePostMutationMutation, CreatePostMutationMutationVariables>({\n      query: CREATE_POST,\n      variables: {\n        data: {\n          title: formData.get(\'title\') as string,\n          content: formData.get(\'content\') as string\n        }\n      }\n    })\n    revalidatePath(\'/\')\n  }\n\n  return <form action={createPost}>\n    <h2>New Post</h2>\n    <label>\n      <span>Title</span>\n      <input name="title" />\n    </label>\n    <label>\n      <span>Content</span>\n      <textarea rows={5} name="content" />\n    </label>\n    <div>\n      <button type="submit">Create</button>\n    </div>\n  </form>\n}\n\nfunction CreateComment({ postId }: { postId: string }) {\n  async function createComment(formData: FormData) {\n    \'use server\'\n\n    const res = await executeGraphql<CreateCommentMutationMutation, CreateCommentMutationMutationVariables>({\n      query: CREATE_COMMENT,\n      variables: {\n        data: {\n          postId,\n          content: formData.get(\'content\') as string\n        }\n      }\n    })\n    console.log(res)\n    revalidatePath(\'/\')\n  }\n  return <form action={createComment}>\n    <div>\n      <textarea name="content" placeholder="Leave a comment..." />\n    </div>\n    <div>\n      <button type="submit">Send</button>\n    </div>\n  </form>\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"Now you should have a working minimal blog example!"})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>o});var a=t(6540);const s={},r=a.createContext(s);function i(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);